"use strict";(self.webpackChunkchatgpt_api=self.webpackChunkchatgpt_api||[]).push([[121],{10394:(L,v,c)=>{c.d(v,{F1:()=>b,_i:()=>m,e9:()=>g});var s=c(15861);const m=d=>d.startsWith("gpt-3.5-turbo-")?"gpt-3.5-turbo":d.startsWith("gpt-4-32k-")?"gpt-4-32k":d.startsWith("gpt-4-")?"gpt-4":d,g=function(){var d=(0,s.Z)(function*(){try{const{encoding_for_model:f}=yield c.e(451).then(c.bind(c,40451));return{encoding_for_model:f}}catch(f){return console.log(f),{encoding_for_model:null}}});return function(){return d.apply(this,arguments)}}(),b=function(){var d=(0,s.Z)(function*({prompt:f,modelName:_}){const{encoding_for_model:h}=yield g();let a=Math.ceil(f.length/4);try{if(h){const u=h(m(_));a=u.encode(f).length,u.free()}}catch(u){console.warn("Failed to calculate number of tokens with tiktoken, falling back to approximate count",u)}return(d=>{switch(m(d)){case"text-davinci-003":default:return 4097;case"text-curie-001":case"text-babbage-001":case"text-ada-001":case"code-cushman-001":return 2048;case"code-davinci-002":return 8e3}})(_)-a});return function(_){return d.apply(this,arguments)}}()},88121:(L,v,c)=>{c.d(v,{q:()=>_});var s=c(15861),m=c(61083),p=c(57265),g=c(77712);class b{constructor(a){Object.defineProperty(this,"maxConcurrency",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"maxRetries",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"queue",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.maxConcurrency=a.maxConcurrency??1/0,this.maxRetries=a.maxRetries??6,this.queue=new(0,g.default)({concurrency:this.maxConcurrency})}call(a,...l){return this.queue.add(()=>p(()=>a(...l).catch(u=>{throw u instanceof Error?u:new Error(u)}),{retries:this.maxRetries,randomize:!0}),{throwOnTimeout:!0})}}var d=c(10394);class _{constructor(a){Object.defineProperty(this,"verbose",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"callbackManager",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"caller",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_encoding",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_registry",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.verbose=a.verbose??!!a.callbackManager,this.callbackManager=a.callbackManager??(0,m.Lo)(),this.caller=new b(a??{})}getNumTokens(a){var l=this;return(0,s.Z)(function*(){let u=Math.ceil(a.length/4);try{if(!l._encoding){const{encoding_for_model:y}=yield(0,d.e9)();y&&(l._encoding=y("modelName"in l?(0,d._i)(l.modelName):"gpt2"),l._registry=new FinalizationRegistry(e=>e.free()),l._registry.register(l,l._encoding))}l._encoding&&(u=l._encoding.encode(a).length)}catch(y){console.warn("Failed to calculate number of tokens with tiktoken, falling back to approximate count",y)}return u})()}_identifyingParams(){return{}}serialize(){return{...this._identifyingParams(),_type:this._llmType(),_model:this._modelType()}}static deserialize(a){return(0,s.Z)(function*(){const{_type:l,_model:u,...y}=a;if(u&&"base_chat_model"!==u)throw new Error(`Cannot load LLM with model ${u}`);const e={openai:(yield c.e(331).then(c.bind(c,51331))).ChatOpenAI}[l];if(void 0===e)throw new Error(`Cannot load  LLM with type ${l}`);return new e(y)})()}}},61083:(L,v,c)=>{c.d(v,{Lo:()=>a});var s=c(15861);class m{}class p extends m{constructor(e){super(),Object.defineProperty(this,"alwaysVerbose",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"ignoreLLM",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"ignoreChain",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"ignoreAgent",{enumerable:!0,configurable:!0,writable:!0,value:!1}),e&&(this.alwaysVerbose=e.alwaysVerbose??this.alwaysVerbose,this.ignoreLLM=e.ignoreLLM??this.ignoreLLM,this.ignoreChain=e.ignoreChain??this.ignoreChain,this.ignoreAgent=e.ignoreAgent??this.ignoreAgent)}}class g extends p{setHandler(e){return this.setHandlers([e])}}class b extends g{constructor(){super(),Object.defineProperty(this,"handlers",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.handlers=[]}handleLLMStart(e,r,n){var t=this;return(0,s.Z)(function*(){yield Promise.all(t.handlers.map(function(){var o=(0,s.Z)(function*(i){if(!i.ignoreLLM&&(n||i.alwaysVerbose))try{yield i.handleLLMStart?.(e,r)}catch(w){console.error(`Error in handler ${i.constructor.name}, handleLLMStart: ${w}`)}});return function(i){return o.apply(this,arguments)}}()))})()}handleLLMNewToken(e,r){var n=this;return(0,s.Z)(function*(){yield Promise.all(n.handlers.map(function(){var t=(0,s.Z)(function*(o){if(!o.ignoreLLM&&(r||o.alwaysVerbose))try{yield o.handleLLMNewToken?.(e)}catch(i){console.error(`Error in handler ${o.constructor.name}, handleLLMNewToken: ${i}`)}});return function(o){return t.apply(this,arguments)}}()))})()}handleLLMError(e,r){var n=this;return(0,s.Z)(function*(){yield Promise.all(n.handlers.map(function(){var t=(0,s.Z)(function*(o){if(!o.ignoreLLM&&(r||o.alwaysVerbose))try{yield o.handleLLMError?.(e)}catch(i){console.error(`Error in handler ${o.constructor.name}, handleLLMError: ${i}`)}});return function(o){return t.apply(this,arguments)}}()))})()}handleLLMEnd(e,r){var n=this;return(0,s.Z)(function*(){yield Promise.all(n.handlers.map(function(){var t=(0,s.Z)(function*(o){if(!o.ignoreLLM&&(r||o.alwaysVerbose))try{yield o.handleLLMEnd?.(e)}catch(i){console.error(`Error in handler ${o.constructor.name}, handleLLMEnd: ${i}`)}});return function(o){return t.apply(this,arguments)}}()))})()}handleChainStart(e,r,n){var t=this;return(0,s.Z)(function*(){yield Promise.all(t.handlers.map(function(){var o=(0,s.Z)(function*(i){if(!i.ignoreChain&&(n||i.alwaysVerbose))try{yield i.handleChainStart?.(e,r)}catch(w){console.error(`Error in handler ${i.constructor.name}, handleChainStart: ${w}`)}});return function(i){return o.apply(this,arguments)}}()))})()}handleChainError(e,r){var n=this;return(0,s.Z)(function*(){yield Promise.all(n.handlers.map(function(){var t=(0,s.Z)(function*(o){if(!o.ignoreChain&&(r||o.alwaysVerbose))try{yield o.handleChainError?.(e)}catch(i){console.error(`Error in handler ${o.constructor.name}, handleChainError: ${i}`)}});return function(o){return t.apply(this,arguments)}}()))})()}handleChainEnd(e,r){var n=this;return(0,s.Z)(function*(){yield Promise.all(n.handlers.map(function(){var t=(0,s.Z)(function*(o){if(!o.ignoreChain&&(r||o.alwaysVerbose))try{yield o.handleChainEnd?.(e)}catch(i){console.error(`Error in handler ${o.constructor.name}, handleChainEnd: ${i}`)}});return function(o){return t.apply(this,arguments)}}()))})()}handleToolStart(e,r,n){var t=this;return(0,s.Z)(function*(){yield Promise.all(t.handlers.map(function(){var o=(0,s.Z)(function*(i){if(!i.ignoreAgent&&(n||i.alwaysVerbose))try{yield i.handleToolStart?.(e,r)}catch(w){console.error(`Error in handler ${i.constructor.name}, handleToolStart: ${w}`)}});return function(i){return o.apply(this,arguments)}}()))})()}handleToolError(e,r){var n=this;return(0,s.Z)(function*(){yield Promise.all(n.handlers.map(function(){var t=(0,s.Z)(function*(o){if(!o.ignoreAgent&&(r||o.alwaysVerbose))try{yield o.handleToolError?.(e)}catch(i){console.error(`Error in handler ${o.constructor.name}, handleToolError: ${i}`)}});return function(o){return t.apply(this,arguments)}}()))})()}handleToolEnd(e,r){var n=this;return(0,s.Z)(function*(){yield Promise.all(n.handlers.map(function(){var t=(0,s.Z)(function*(o){if(!o.ignoreAgent&&(r||o.alwaysVerbose))try{yield o.handleToolEnd?.(e)}catch(i){console.error(`Error in handler ${o.constructor.name}, handleToolEnd: ${i}`)}});return function(o){return t.apply(this,arguments)}}()))})()}handleText(e,r){var n=this;return(0,s.Z)(function*(){yield Promise.all(n.handlers.map(function(){var t=(0,s.Z)(function*(o){if(r||o.alwaysVerbose)try{yield o.handleText?.(e)}catch(i){console.error(`Error in handler ${o.constructor.name}, handleText: ${i}`)}});return function(o){return t.apply(this,arguments)}}()))})()}handleAgentAction(e,r){var n=this;return(0,s.Z)(function*(){yield Promise.all(n.handlers.map(function(){var t=(0,s.Z)(function*(o){if(!o.ignoreAgent&&(r||o.alwaysVerbose))try{yield o.handleAgentAction?.(e)}catch(i){console.error(`Error in handler ${o.constructor.name}, handleAgentAction: ${i}`)}});return function(o){return t.apply(this,arguments)}}()))})()}handleAgentEnd(e,r){var n=this;return(0,s.Z)(function*(){yield Promise.all(n.handlers.map(function(){var t=(0,s.Z)(function*(o){if(!o.ignoreAgent&&(r||o.alwaysVerbose))try{yield o.handleAgentEnd?.(e)}catch(i){console.error(`Error in handler ${o.constructor.name}, handleAgentEnd: ${i}`)}});return function(o){return t.apply(this,arguments)}}()))})()}addHandler(e){this.handlers.push(e)}removeHandler(e){this.handlers=this.handlers.filter(r=>r!==e)}setHandlers(e){this.handlers=e}static fromHandlers(e){const n=new this;return n.addHandler(new class r extends p{constructor(){super(),Object.defineProperty(this,"alwaysVerbose",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.assign(this,e)}}),n}}class d extends p{handleChainStart(e){return(0,s.Z)(function*(){console.log(`Entering new ${e.name} chain...`)})()}handleChainEnd(e){return(0,s.Z)(function*(){console.log("Finished chain.")})()}handleAgentAction(e){return(0,s.Z)(function*(){console.log(e.log)})()}handleToolEnd(e){return(0,s.Z)(function*(){console.log(e)})()}handleText(e){return(0,s.Z)(function*(){console.log(e)})()}handleAgentEnd(e){return(0,s.Z)(function*(){console.log(e.log)})()}}class f extends p{constructor(){super(),Object.defineProperty(this,"session",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"stack",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"executionOrder",{enumerable:!0,configurable:!0,writable:!0,value:1}),this.alwaysVerbose=!0}newSession(e){var r=this;return(0,s.Z)(function*(){const n={start_time:Date.now(),name:e},t=yield r.persistSession(n);return r.session=t,t})()}_addChildRun(e,r){if("llm"===r.type)e.child_llm_runs.push(r);else if("chain"===r.type)e.child_chain_runs.push(r);else{if("tool"!==r.type)throw new Error("Invalid run type");e.child_tool_runs.push(r)}}_startTrace(e){if(this.executionOrder+=1,this.stack.length>0){if("tool"!==this.stack.at(-1)?.type&&"chain"!==this.stack.at(-1)?.type)throw new Error("Nested run can only be logged for tool or chain");const r=this.stack.at(-1);this._addChildRun(r,e)}this.stack.push(e)}_endTrace(){var e=this;return(0,s.Z)(function*(){const r=e.stack.pop();0===e.stack.length&&r&&(e.executionOrder=1,yield e.persistRun(r))})()}handleLLMStart(e,r,n){var t=this;return(0,s.Z)(function*(){void 0===t.session&&(t.session=yield t.loadDefaultSession());const o={start_time:Date.now(),end_time:0,serialized:e,prompts:r,session_id:t.session.id,execution_order:t.executionOrder,type:"llm"};t._startTrace(o)})()}handleLLMEnd(e,r){var n=this;return(0,s.Z)(function*(){if(0===n.stack.length||"llm"!==n.stack.at(-1)?.type)throw new Error("No LLM run to end.");const t=n.stack.at(-1);t.end_time=Date.now(),t.response=e,yield n._endTrace()})()}handleLLMError(e,r){var n=this;return(0,s.Z)(function*(){if(0===n.stack.length||"llm"!==n.stack.at(-1)?.type)throw new Error("No LLM run to end.");const t=n.stack.at(-1);t.end_time=Date.now(),t.error=e.message,yield n._endTrace()})()}handleChainStart(e,r,n){var t=this;return(0,s.Z)(function*(){void 0===t.session&&(t.session=yield t.loadDefaultSession());const o={start_time:Date.now(),end_time:0,serialized:e,inputs:r,session_id:t.session.id,execution_order:t.executionOrder,type:"chain",child_llm_runs:[],child_chain_runs:[],child_tool_runs:[]};t._startTrace(o)})()}handleChainEnd(e,r){var n=this;return(0,s.Z)(function*(){if(0===n.stack.length||"chain"!==n.stack.at(-1)?.type)throw new Error("No chain run to end.");const t=n.stack.at(-1);t.end_time=Date.now(),t.outputs=e,yield n._endTrace()})()}handleChainError(e,r){var n=this;return(0,s.Z)(function*(){if(0===n.stack.length||"chain"!==n.stack.at(-1)?.type)throw new Error("No chain run to end.");const t=n.stack.at(-1);t.end_time=Date.now(),t.error=e.message,yield n._endTrace()})()}handleToolStart(e,r,n){var t=this;return(0,s.Z)(function*(){void 0===t.session&&(t.session=yield t.loadDefaultSession());const o={start_time:Date.now(),end_time:0,serialized:e,tool_input:r,session_id:t.session.id,execution_order:t.executionOrder,type:"tool",action:JSON.stringify(e),child_llm_runs:[],child_chain_runs:[],child_tool_runs:[]};t._startTrace(o)})()}handleToolEnd(e,r){var n=this;return(0,s.Z)(function*(){if(0===n.stack.length||"tool"!==n.stack.at(-1)?.type)throw new Error("No tool run to end");const t=n.stack.at(-1);t.end_time=Date.now(),t.output=e,yield n._endTrace()})()}handleToolError(e,r){var n=this;return(0,s.Z)(function*(){if(0===n.stack.length||"tool"!==n.stack.at(-1)?.type)throw new Error("No tool run to end.");const t=n.stack.at(-1);t.end_time=Date.now(),t.error=e.message,yield n._endTrace()})()}}class _ extends f{constructor(){super(),Object.defineProperty(this,"endpoint",{enumerable:!0,configurable:!0,writable:!0,value:(typeof process<"u"?process.env.LANGCHAIN_ENDPOINT:void 0)||"http://localhost:8000"}),Object.defineProperty(this,"headers",{enumerable:!0,configurable:!0,writable:!0,value:{"Content-Type":"application/json"}}),typeof process<"u"&&process.env.LANGCHAIN_API_KEY&&(this.headers["x-api-key"]=process.env.LANGCHAIN_API_KEY)}persistRun(e){var r=this;return(0,s.Z)(function*(){let n;n="llm"===e.type?`${r.endpoint}/llm-runs`:"chain"===e.type?`${r.endpoint}/chain-runs`:`${r.endpoint}/tool-runs`;const t=yield fetch(n,{method:"POST",headers:r.headers,body:JSON.stringify(e)});t.ok||console.error(`Failed to persist run: ${t.status} ${t.statusText}`)})()}persistSession(e){var r=this;return(0,s.Z)(function*(){const n=`${r.endpoint}/sessions`,t=yield fetch(n,{method:"POST",headers:r.headers,body:JSON.stringify(e)});return t.ok?{id:(yield t.json()).id,...e}:(console.error(`Failed to persist session: ${t.status} ${t.statusText}, using default session.`),{id:1,...e})})()}loadSession(e){var r=this;return(0,s.Z)(function*(){return r._handleSessionResponse(`${r.endpoint}/sessions?name=${e}`)})()}loadDefaultSession(){var e=this;return(0,s.Z)(function*(){return e._handleSessionResponse(`${e.endpoint}/sessions?name=default`)})()}_handleSessionResponse(e){var r=this;return(0,s.Z)(function*(){const n=yield fetch(e,{method:"GET",headers:r.headers});let t;if(!n.ok)return console.error(`Failed to load session: ${n.status} ${n.statusText}`),t={id:1,start_time:Date.now()},r.session=t,t;const o=yield n.json();return 0===o.length?(t={id:1,start_time:Date.now()},r.session=t,t):([t]=o,r.session=t,t)})()}}class h extends b{constructor(){super()}static getInstance(){return h.instance||(h.instance=new h,h.instance.addHandler(new d),typeof process<"u"&&"langchain"===process.env.LANGCHAIN_HANDLER&&h.instance.addHandler(new _)),h.instance}}function a(){return h.getInstance()}},15861:(L,v,c)=>{function s(p,g,b,d,f,_,h){try{var a=p[_](h),l=a.value}catch(u){return void b(u)}a.done?g(l):Promise.resolve(l).then(d,f)}function m(p){return function(){var g=this,b=arguments;return new Promise(function(d,f){var _=p.apply(g,b);function h(l){s(_,d,f,h,a,"next",l)}function a(l){s(_,d,f,h,a,"throw",l)}h(void 0)})}}c.d(v,{Z:()=>m})}}]);